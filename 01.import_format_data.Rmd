---
title: "01.import_format_data"
author: "Guillaume Papuga"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages}
require(here)
library(tidyverse)
library(stringr)
library(raster)
library(rgdal)
library(sf) #shapefile
library(dismo)
```


# Pense bête - a faire
## variables
- la temporalité de l'eau, sur 1 an et 3 ans (moyenne) 
- le MSAVI. Dans l'idéal, il faudrait qu'on fasse un petit bilan des indices de productivité végétale (MSAVI, MSAVI2, NDVI, autre...?) pour pouvoir choisir le plus approprié (voir les comparer?)
- raster d'altitude MNT : joindre les couches + mise au bon format
- raster de distance aux masses d'eau salée permanente (mer + lagunes d'une taille > 1 ha, à définir) : faire une couche vecteur, calculer distance aux entités, remettre à la bonne ehcelle 
- faire un masque d'eau permanente (ajouter pixels de bordure)

- presence : faire une couche vecteur + extraire les données contenues dedans

## code
- faire les graphiques de réponse par variable (ordonnée 1-0)
- implémenter différents algo dans SDM
- lisser le code

# Introduction
## Article
Data processed in this file belongs to a project that aims at mapping the distribution of Mediterranean temporary lagoons. 

## Format
This document is used to format data. No analysis is coded here.
All data names once processed follow the form d.something (d stands for "data", and the second part must clearly refer to the type of data).

## Environmental variables (section 1.)
The aim of this section is to format all the environment variables. They are spatial layers (rasters) that require some pre-processing to perform spatial analysis

## Occurences (section 2.)
The aim of this section is to build a database of occurence to train the model. We used different strategies to sample pixels based on known occurences of mediterranean temporary lagoon 

# Pre-processing

## a. Download the base layer
```{r}
## hydroperiod
## 1. Upload from external drive
source = "/Volumes/My Passport for Mac/spatial.data/09.projets.specifiques/couches_lag.temp/raw.layers/" # folder path
var.name = "hydroperiod_sep2018_sep2019.tif" # name of the variable in the initial folder
var.path.name = as.vector(paste (source, var.name, sep="")) # paste the right name
hydroperiod = raster(var.path.name)
```

## b. Define the basic setting of raster layers
```{r}
## Set the basic parameters
# each time you want to stack data, you have to respect the same PER : PROJECTION - EXTENT - RESOLUTION
# it's called the standard settings of the project and it's p.

# Same projection
p.proj = "+proj=longlat +datum=WGS84"
projection(hydroperiod) # read the projection definition (raster dataset)

# Same extent
p.extent = extent(hydroperiod)

# Same resolution 
p.res = res(hydroperiod)
```

## c. Correct the projection of the hydroperiod layer
```{r}
hydroperiod.wgs = projectRaster(hydroperiod,
                                  crs = p.proj) # change the CRS of the raster to WGS84
```


# 1. Load Mediterranean Temporary Lagoon (MTL) data
## a. Dataset structure
```{r}
# The matrix is named `d.lag` and must contain 6 columns
# pix.id : indefinite pixel code (dataset specific)
# had.id : identifica
# date : the date (yyyymmdd)
# x : coordinate on the x-axis (longitude in decimal degree)
# y : coordinate on the y-axis (latitude in decimal degree)
# precision : precision of the location (expressed in meter)
# source : explicit name of the source of the imported dataset

d.lag = as.data.frame(matrix (ncol = 7,nrow = 0))
colnames (d.occ) = c("code.pop", "sp.name", "date", "x", "y", "precision", "source")
```


## b. Hand pointed data (presence)
```{r}
# load raw data
## 1. Upload from external drive
source = "/Volumes/My Passport for Mac/spatial.data/09.projets.specifiques/couches_lag.temp/raw.layers/" # folder path
var.name = "lag.temp.shp" # name of the variable in the initial folder
var.path.name = as.vector(paste (source, var.name, sep="")) # paste the right name
psce = st_read(var.path.name)

## 2. Check and convert (if needed) the raster layer
# Same projection
projection(psce) # read the projection definition (raster dataset)
psce.wgs = st_transform(psce, p.proj)
```

This dataset contains `r nb.row` populations.

## b. Study Area (Polygon)
```{r}
# circles with a radius of 50 km
tab.psce.wgs = as.data.frame (cbind (st_coordinates(psce.wgs), 
                                    rep(1, nrow(psce.wgs))))
x = circles(tab.psce.wgs[,1:2], d=5000, lonlat=TRUE) 
## Loading required namespace: rgeos 
study.area = polygons(x)
```


## c. Random absence data
#```{r}
# load raw data
## 1. Upload from external drive
source = "/Volumes/My Passport for Mac/spatial.data/09.projets.specifiques/couches_lag.temp/raw.layers/" # folder path
var.name = "absence.shp" # name of the variable in the initial folder
var.path.name = as.vector(paste (source, var.name, sep="")) # paste the right name
abs = st_read(var.path.name)

## 2. Check and convert (if needed) the vector layer
# Same projection
projection(abs) # read the projection definition (raster dataset)
abs.wgs = abs
#```

```{r}
# create background data
bg = spsample(study.area, 5000, type='random', iter=25)
```



## c. Synthese
```{r}
# convert each spatial layer into a dataframe
tab.psce.wgs = as.data.frame (cbind (st_coordinates(psce.wgs), 
                                    rep(1, nrow(psce.wgs))))

tab.abs.wgs = cbind (as.data.frame (bg), # coordinates of each point in the vector
                    rep(0, nrow(as.data.frame (bg)))) # 1-0 lagoon value

# delete duplicate btw datasets
cells.p = cellFromXY(hydroperiod.wgs, st_coordinates(psce.wgs)) # cell n°
cells.p = unique (cells.p)

cells.a = cellFromXY(hydroperiod.wgs, as.data.frame (bg)) # cell n°
cells.a = unique (cells.a)

cells = setdiff(cells.a, cells.p) # identify cells specific from a

tab.abs.wgs = tab.abs.wgs %>%
  mutate (cell.n = cellFromXY(hydroperiod.wgs, as.data.frame (bg))) %>% # add the column
  distinct(cell.n, .keep_all = TRUE) %>% # eliminate duplicate
  filter(cell.n %in% cells) # select in the cells list
tab.abs.wgs = tab.abs.wgs[,-4] # delete the cell column

# rbind the two datasets
colnames (tab.abs.wgs) = c("x", "y", "lag") # change columns name
colnames (tab.psce.wgs) = c("x", "y", "lag") # change columns name
tab.pa = rbind (tab.abs.wgs, tab.psce.wgs) # bind the two tables
tab.pa = (tab.pa[complete.cases(tab.pa), ]) # remove NA

# transform the matrix into a spatial point file
coordinates (tab.pa) = ~x*y # the name of the x and y columns
proj4string (tab.pa) = p.proj # attributes a projection for the object, it DOES NOT reproject
spplot(tab.pa) # plot the spatial data with attributes
```


## d. Polygon data coming soon





# 2. Environmental data
The aim is to format X dataset : 
- hydroperiod (hydrological temporality based on Tour du Valat index - Sentinel 2 images)
- msavi.spring (**median** value of M-Savi2 during the vegetative period from february to june)
- msavi.july (M-Savi2 index of the july image)
- mnt (altitude based on the the original MNT)
- distance to shore and major salt-water body (calculated from a vector file)

We use the **hydroperiod** layer as a basis to define the cell size.

## d. Upload all other data
### msavi.spring
```{r}
## msavi.spring
## 1. Upload from external drive
source = "/Volumes/My Passport for Mac/spatial.data/09.projets.specifiques/couches_lag.temp/raw.layers/MSAVI2/" # folder path
lst = list.files(path = source, pattern='tif$') [6:13] # list all the file and keep the spring ones
st = stack (as.list(paste (source, lst, sep=""))) # create the raster stack
r_median = calc(st, median) # take the median of the serie

## 2. Check and convert (if needed) the raster layer
# Same projection
projection(r_median) # read the projection definition (raster dataset)
r_median.wgs = projectRaster(r_median, 
                             crs = p.proj) # reproject

# Same extent
extent(r_median.wgs)

# Same resolution 
res(r_median.wgs)

##if the cell size is not the same, you need to convert it
# a. change the pixel size with aggregate or disaggregate

# b. resample the value with resample () (package raster)

# test = projectRaster(bioclim.var, crs = p.proj) # transform the projection into a new one (raster dataset)
```

### msavi.july
```{r}
## msavi.july
## 1. Upload from external drive
source = "/Volumes/My Passport for Mac/spatial.data/09.projets.specifiques/couches_lag.temp/raw.layers/MSAVI2/" # folder path
var.name = "MSAVI2_20m_T31TEJ_20190722.tif" # name of the variable in the initial folder
var.path.name = as.vector(paste (source, var.name, sep="")) # paste the right name
msavi.july = raster(var.path.name)

## 2. Check and convert (if needed) the raster layer
# Same projection
projection(msavi.july) # read the projection definition (raster dataset)
msavi.july.wgs = projectRaster(msavi.july,
                               crs = p.proj) 

# Same extent
extent(msavi.july.wgs)

# Same resolution 
res(msavi.july.wgs)

##if the cell size is not the same, you need to convert it
# a. change the pixel size with aggregate or disaggregate

# b. resample the value with resample () (package raster)

# test = projectRaster(bioclim.var, crs = p.proj) # transform the projection into a new one (raster dataset)
```



### Environment-data stack
```{r}
# Ecological variables
## Stack all files together
## This is a way to check that everything has been done carefully and raster layers are compatible

ecov = stack (hydroperiod.wgs, 
              r_median.wgs,
              msavi.july.wgs)

ecov.crop = crop(ecov, study.area)
```







