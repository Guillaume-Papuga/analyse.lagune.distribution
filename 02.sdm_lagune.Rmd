---
title: "02.sdm_lagune"
author: "Guillaume Papuga"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE, include=FALSE, message=FALSE, warning=FALSE)
```

```{r packages}
library (tidyverse)
library (ade4)
library (here)
library (stringr)
library (ade4)
library (dismo)
library (mapdata)
library (maps)
library (maptools)
library (raster)
library (rgdal)
library (rgeos)
library (sdm)
library (sp)
library (usdm) 
```

# Loading data
First of all, you need to run the rMarkdown document named "01.import_format_data.Rmd" to load all the data in the R session
- 1. ecological variables are grouped into a stacked raster named `ecov`
- 2. p-a data from GIS handmade points are grouped in a spatial point file named `tab.pa`
- 3. p-a data with complete habitat structure (to distinguish one habitat from another) are to be created


```{r}
# presence
psc = extract(ecov, lag.93, weights = TRUE, normalizeWeights = FALSE, factors = TRUE) %>%
  melt () %>%
  dcast (Var1 + L1 ~Var2, value.var = "value") %>%
  filter (weight == 1) %>% # exclude cells not totally contained in the polygon (avoid mixels)
  dplyr::select (-c(weight, Var1)) %>% # delete the column
  rename(lag = L1) %>%
  mutate (presence = 1) %>%
  arrange (lag)

# background
bg = extract(ecov, abs.area, weights = TRUE, normalizeWeights = FALSE, factors = TRUE) %>%
  melt () %>%
  dcast (Var1 + L1 ~Var2, value.var = "value") %>%
  filter (weight == 1) %>% # exclude cells not totally contained in the polygon (avoid mixels)
  dplyr::select (-c(weight, Var1)) %>% # delete the column
  rename(lag = L1) %>%
  mutate(lag = NA) %>%
  mutate (presence = 0)

# join
mat = bind_rows(psc, bg) # with bind row from dplyr (anyway, columns are identical here, rbind would work)

# write the table
write.csv (mat, here::here("data", "processed", "pa.mat.csv"))
```


# PART I : Data mining

## Hydroperiod
```{r data mining hydroperiod}
# reduce absences
data.plot = mat 

# plot
# histogram
ggplot(data.plot[,"hydroperiod"], aes(x = hydroperiod)) + 
  geom_histogram(aes(y=..density..), position="identity", alpha=0.5) +
  geom_density(alpha=0.6) +
  scale_color_manual(values=c("#999999", "#E69F00", "#56B4E9")) +
  scale_fill_manual(values=c("#999999", "#E69F00", "#56B4E9")) +
  labs(title="Hydroperiod histogram plot",x="Hydroperiod (days)", y = "Density") +
  theme_classic()

# binary plot with smoother
ggplot(data.plot, aes(x = altitude.wgs.c.adj , y = presence)) +
  geom_point() +
  stat_smooth () +
  labs(title="Hydroperiod plot", x = "Hydroperiod (days)", y = "Lagoon") +
  theme_classic()
```

## Msavi


## Altitude

## Correlation amon variables



# PART II : simple GLM procedure (handmade)



## 1. variable selection
```{r}
# Only three variables in the model
```

## 2. model
```{r}
# 1. Split the data set
training = sample_n(df, 10)


test = sample_n(df, 10)



# 2. Run the model
# due to the shape of the response curve we added a square term to hydroperiod and msavi
m1 = glm(presence ~ hydroperiod.93 +
           I(hydroperiod.93^2) +
           msavi.93 + 
           I(msavi.93^2) +
           altitude.93.c.adj, 
         data = training, family = "binomial")

summary(m1) # model summary

# 3. evaluate the model
# to come (see Hijmann too for AUC)

# 4. predict over the whole map
pred.glm = predict (ecov, m1, type = "response")

# 5. save the map
writeRaster(x = pred.glm.c, 
            filename = "/Volumes/My Passport for Mac/spatial.data/09.projets.specifiques/couches_lag.temp/raw.layers/raw.res/test.pred.glm.crop.tif")
```

```{r}
# Plot the result of the GLM over the Frontignan area
# 1. crop the variables
pred.glm.fronti
plot(pred.glm.fronti)

# add points
df.sp1 = as.data.frame(sp1)
points (df.sp1[which (df.sp1$Occurrence == 1), c(2,3)], 
        pch = 16, col = "red", cex = 0.5)
points (df.sp1[which (df.sp1$Occurrence == 0), c(2,3)], 
        pch = 16, col = "blue", cex = 0.3)
```




# PART III : General additive model
```{r}

```




# Part IV : **sdm** package procedure
```{r}

```












